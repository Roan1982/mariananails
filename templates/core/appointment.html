{% extends "base.html" %}
{% load static %}

{% block extra_head %}
    {{ block.super }}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet">
{% endblock %}

{% block title %}Reservar turno · {{ COMPANY_NAME }}{% endblock %}

{% block content %}
<section class="py-5">
    <div class="container">
        <div class="booking-hero mb-5">
            <div class="row align-items-center g-4">
                <div class="col-lg-7">
                    <span class="info-pill"><i class="bi bi-stars"></i> Experiencia premium en manos</span>
                    <h1 class="booking-hero__title mt-3">Reservá tu momento de manicure con estilo</h1>
                    <p class="booking-hero__subtitle">Coordiná tu visita en tres pasos: elegí el servicio, seleccioná fecha y horario, y cargá la seña del {{ deposit_percentage }}% para asegurar tu lugar.</p>
                    <ul class="list-unstyled d-flex flex-wrap booking-steps">
                        <li class="booking-step"><i class="bi bi-brush"></i> Servicio ideal</li>
                        <li class="booking-step"><i class="bi bi-calendar-heart"></i> Fecha + horario</li>
                        <li class="booking-step"><i class="bi bi-shield-check"></i> Seña confirmada</li>
                    </ul>
                </div>
                <div class="col-lg-5 text-center">
                    <img src="{% static 'img/hero-placeholder.svg' %}" alt="Manicuría profesional" class="img-fluid" style="max-height: 260px;">
                </div>
            </div>
        </div>

        <div class="row g-4">
            <div class="col-lg-7">
                <div class="card booking-card mb-4">
                    <div class="booking-card__header">
                        <h2 class="h4 fw-bold mb-1">Programá tu turno</h2>
                        <small>Completá los datos y recibirás la confirmación apenas validemos la seña.</small>
                    </div>
                    <div class="booking-card__body">
                        <div class="payment-note mb-4"><i class="bi bi-info-circle me-1"></i> Para mantener tu turno reservado necesitamos verificar el pago de la seña del {{ deposit_percentage }}%. Podés hacerlo por transferencia, Mercado Pago o abonando en el local.</div>
                        <form method="post" class="needs-validation" novalidate>
                            {% csrf_token %}
                            {{ form.non_field_errors }}

                            <span class="form-section-title">1 · Detalles del servicio</span>
                            <div class="row g-3 align-items-end mb-4">
                                <div class="col-md-6">
                                    <label class="form-label" for="id_service">Servicio</label>
                                    {{ form.service }}
                                    {{ form.service.errors }}
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label" for="id_appointment_date">Fecha</label>
                                    {{ form.appointment_date }}
                                    {{ form.appointment_date.errors }}
                                </div>
                                <div class="col-12">
                                    <label class="form-label" for="id_appointment_time">Horario disponible</label>
                                    {% if available_slots %}
                                        {{ form.appointment_time }}
                                    {% else %}
                                        <div class="alert alert-warning mb-0">No quedan horarios disponibles para la fecha seleccionada. Probá con otro día.</div>
                                    {% endif %}
                                    {{ form.appointment_time.errors }}
                                </div>
                            </div>

                            <span class="form-section-title">2 · Seña y comprobante</span>
                            <div class="row g-3 align-items-start mb-4">
                                <div class="col-lg-6 col-md-12">
                                    <label class="form-label" for="id_payment_method">Medio de pago</label>
                                    {{ form.payment_method }}
                                    {{ form.payment_method.errors }}
                                </div>
                                <div class="col-lg-6 col-md-12">
                                    <label class="form-label" for="id_payment_reference">Comprobante</label>
                                    {{ form.payment_reference }}
                                    {{ form.payment_reference.errors }}
                                    {% if form.payment_reference.help_text %}
                                        <div class="form-text">{{ form.payment_reference.help_text }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-12">
                                    <div id="depositSummary" class="deposit-card d-none">
                                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                            <div>
                                                <span class="text-uppercase text-muted small">Seña estimada</span>
                                                <div id="depositAmount" class="fw-bold fs-5">--</div>
                                            </div>
                                            <span class="badge rounded-pill text-bg-light text-muted"><i class="bi bi-clock-history me-1"></i> Validamos en pocas horas</span>
                                        </div>
                                        <p class="small text-muted mb-0 mt-2">Una vez que verifiquemos el pago, vas a recibir la confirmación definitiva por mail.</p>
                                    </div>
                                </div>
                            </div>

                            <span class="form-section-title">3 · Notas opcionales</span>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label" for="id_notes">Notas (opcional)</label>
                                    {{ form.notes }}
                                    {{ form.notes.errors }}
                                </div>
                            </div>

                            <div class="d-flex justify-content-end mt-4">
                                <button type="submit" class="btn btn-primary btn-lg px-4" {% if not available_slots %}disabled{% endif %}>
                                    <i class="bi bi-calendar-check me-2"></i>Confirmar turno
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="card shadow-sm border-0 p-4">
                    <h5 class="fw-semibold mb-3"><i class="bi bi-clock me-2"></i>Disponibilidad del {{ selected_date|date:"d/m/Y" }}</h5>
                    <div class="d-flex flex-wrap gap-2">
                        {% for slot in all_slots %}
                            {% if slot in taken_slots %}
                                <span class="badge text-bg-secondary px-3 py-2"><i class="bi bi-lock-fill me-1"></i>{{ slot }} · Reservado</span>
                            {% else %}
                                <span class="badge text-bg-success px-3 py-2"><i class="bi bi-unlock me-1"></i>{{ slot }} · Libre</span>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card timeline-card border-0">
                    <div class="card-header bg-transparent border-0 pb-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="fw-semibold mb-0"><i class="bi bi-heart-fill text-danger me-2"></i>Mis próximos turnos</h5>
                            <span class="timeline-card__badge badge text-bg-light">{{ upcoming_appointments|length }} activos</span>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if upcoming_appointments %}
                            <ul class="list-group list-group-flush">
                                {% for appointment in upcoming_appointments %}
                                    <li class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-start gap-3">
                                            <div>
                                                <div class="appointment-service">{{ appointment.service.name }}</div>
                                                <div class="appointment-meta">{{ appointment.appointment_date|date:"d/m/Y" }} · {{ appointment.appointment_time }}</div>
                                                <div class="deposit-status-label mt-1">Seña: $ {{ appointment.deposit_amount|floatformat:2 }} · {{ appointment.get_deposit_status_display }}</div>
                                            </div>
                                            {% if appointment.status == 'confirmed' %}
                                                <span class="status-chip status-chip--confirmed"><i class="bi bi-check2-circle"></i> Confirmado</span>
                                            {% elif appointment.status == 'cancelled' %}
                                                <span class="status-chip status-chip--cancelled"><i class="bi bi-x-circle"></i> Cancelado</span>
                                            {% else %}
                                                <span class="status-chip status-chip--pending"><i class="bi bi-hourglass-split"></i> Pendiente</span>
                                            {% endif %}
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="bi bi-calendar2-heart fs-2 d-block mb-2"></i>
                                <p class="mb-0">Cuando confirmes un turno, lo vas a ver acá con todos los detalles.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}

{% block extra_scripts %}
    {{ block.super }}
    {{ services_payment_data|json_script:"services-payment-data" }}
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const $ = window.jQuery;
        const dateField = document.getElementById('id_appointment_date');
        const serviceField = document.getElementById('id_service');
        const depositSummary = document.getElementById('depositSummary');
        const depositAmount = document.getElementById('depositAmount');
        const servicesDataElt = document.getElementById('services-payment-data');
        const servicesData = servicesDataElt ? JSON.parse(servicesDataElt.textContent) : {};

        if ($) {
            const selectElements = document.querySelectorAll('.select2-field');
            selectElements.forEach((element) => {
                const placeholder = element.dataset.placeholder || element.getAttribute('placeholder') || '';
                const allowClear = !element.required;
                $(element).select2({
                    theme: 'bootstrap-5',
                    width: '100%',
                    placeholder: placeholder || undefined,
                    allowClear: allowClear,
                    minimumResultsForSearch: element.options.length > 8 ? 0 : Infinity,
                    language: {
                        noResults: function () {
                            return 'Sin resultados';
                        },
                        searching: function () {
                            return 'Buscando...';
                        }
                    }
                });
            });

            $(document).on('select2:open', () => {
                const searchField = document.querySelector('.select2-container--open .select2-search__field');
                if (searchField) {
                    searchField.focus();
                }
            });
        }

        if (dateField) {
            const todayValue = '{{ today|date:"Y-m-d" }}';
            if (todayValue) {
                dateField.setAttribute('min', todayValue);
            }

            const selectedValue = '{{ selected_date|date:"Y-m-d" }}';
            if (selectedValue) {
                dateField.value = selectedValue;
            }

            dateField.addEventListener('change', function (event) {
                if (!event.target.value) {
                    return;
                }
                const url = new URL(window.location.href);
                url.searchParams.set('date', event.target.value);
                window.location.href = url.toString();
            });
        }

        const updateDepositSummary = () => {
            if (!serviceField || !depositSummary || !depositAmount) {
                return;
            }
            const data = servicesData[serviceField.value];
            if (data) {
                depositAmount.textContent = `$ ${data.deposit}`;
                depositSummary.classList.remove('d-none');
            } else {
                depositAmount.textContent = '--';
                depositSummary.classList.add('d-none');
            }
        };

        if (serviceField) {
            serviceField.addEventListener('change', updateDepositSummary);
            updateDepositSummary();
        }
    });
    </script>
{% endblock %}
